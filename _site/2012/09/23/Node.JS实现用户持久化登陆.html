<!-- 没多少代码，博客所有的代码都在 github 上面，本身也是托管在gitpage上的 -->
<!-- 欢迎交换友情链接，可以微博私信我！ -->
<!doctype html>
<html>
<head>
  <meta charset='utf-8'>
  <meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
  <title>Node.JS实现用户持久化登陆</title>
  <meta name='viewport' content='width=device-width'>
  <meta name='renderer' content='webkit'>
  <link rel='stylesheet' href='/css/main.css' />
</head>
<body>
  <header>
    <h1><a href="http://yutingzhao.com">Love.Passion.Dream</a></h1>
    <nav>
      <ul>
        
          <li>
            <a href='/'>主页</a>
          </li>
        
          <li>
            <a href='/tags.html'>标签</a>
          </li>
        
          <li>
            <a href='/about.html'>我</a>
          </li>
        
          <li>
            <a href='/links.html'>友链</a>
          </li>
        
          <li>
            <a href='/sites.html'>收藏</a>
          </li>
        
      </ul>
    </nav>
  </header>

  <main>
    <article class="box">
  <h1>Node.JS实现用户持久化登陆</h1>
  
  <span class="post-category">
    <span class="label"></span>
  </span>
  <div class="post-meta">
    <time class="post-date">2012-09-23 15:06</time>
  </div>
  <div class="post">
  <p>上周闲着无事写了一个小应用，晒出来之后被深深的鄙视了一把，应用很简单，但是借此研究了一下用node实现基本的用户账号注册登陆的功能。同时也重温了一下用户持久化登陆与账号加密的问题。鉴于下周就国庆放假了，本月还没有博文输出，所以记录一下，权当笔记。</p>

<p>应用托管到了NAE上面，传送门：<a href="http://idushu.cnodejs.net" title="爱读书">爱读书</a>，我用来记录随时闪现在脑海中的书单，也欢迎对这个应用提意见。  </p>

<p>要实现可以有注册用户的应用需要解决两个问题：</p>

<p>①用户账号的注册于密码的加密：</p>

<p>这个是用MD5加密就可以了，这样就可以避免类似之前CSDN出现的密码泄露，至于MD5的具体实现那已经是大三的课程了，表示考完试的时候我就已经忘记了，就摘一段百度百科上面的概要说明一下吧：</p>

<blockquote>
<p><span>当用户登录的时候，系统把用户输入的密码进行MD5 Hash运算，然后再去和保存在文件系统中的MD5值进行比较，进而确定输入的密码是否正确。通过这样的步骤，系统在并不知道用户密码的明码的情况下就可以确定用户登录系统的合法性。这可以避免用户的密码被具有系统管理员权限的用户知道。MD5将任意长度的“字节串”映射为一个128bit的大整数，并且是通过该128bit反推原始字符串是困难的，换句话说就是，即使你看到源程序和算法描述，也无法将一个MD5的值变换回原始的字符串，从数学原理上说，是因为原始的字符串有无穷多个，这有点象不存在反函数的数学函数。</span></p>
</blockquote>

<p><span>MD5的加密可以直接使用node提供的基础模块中的crypto来搞定，实现代码如下：<br>
</span></p>

<p><span></span></p>
<div class="highlight"><pre><code class="javascript language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">md5</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">md5sum</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">createHash</span><span class="p">(</span><span class="s1">&#39;md5&#39;</span><span class="p">);</span>
    <span class="nx">md5sum</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">str</span><span class="p">);</span>
    <span class="nx">str</span> <span class="o">=</span> <span class="nx">md5sum</span><span class="p">.</span><span class="nx">digest</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">str</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p><span>②账号登陆后的持久化实现：</span></p>

<p>实现这个必然就是要使用cookie和session了。用户登录验证了用户名和密码之后把用户名和MD5密码做一个可逆的加密作为cookie保存在浏览器中，这个加密不同于MD5的加密，因为它需要在服务器端可逆解密验证用户。同于也可以使用crypto模块中的方法来搞定。</p>
<div class="highlight"><pre><code class="javascript language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">encrypt</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span><span class="nx">secret</span><span class="p">)</span> <span class="p">{</span>
   <span class="kd">var</span> <span class="nx">cipher</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">createCipher</span><span class="p">(</span><span class="s1">&#39;aes192&#39;</span><span class="p">,</span> <span class="nx">secret</span><span class="p">);</span>
   <span class="kd">var</span> <span class="nx">enc</span> <span class="o">=</span> <span class="nx">cipher</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span><span class="s1">&#39;utf8&#39;</span><span class="p">,</span><span class="s1">&#39;hex&#39;</span><span class="p">);</span>
   <span class="nx">enc</span> <span class="o">+=</span> <span class="nx">cipher</span><span class="p">.</span><span class="kr">final</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">);</span>
   <span class="k">return</span> <span class="nx">enc</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">decrypt</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span><span class="nx">secret</span><span class="p">)</span> <span class="p">{</span>
   <span class="kd">var</span> <span class="nx">decipher</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">createDecipher</span><span class="p">(</span><span class="s1">&#39;aes192&#39;</span><span class="p">,</span> <span class="nx">secret</span><span class="p">);</span>
   <span class="kd">var</span> <span class="nx">dec</span> <span class="o">=</span> <span class="nx">decipher</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span><span class="s1">&#39;hex&#39;</span><span class="p">,</span><span class="s1">&#39;utf8&#39;</span><span class="p">);</span>
   <span class="nx">dec</span> <span class="o">+=</span> <span class="nx">decipher</span><span class="p">.</span><span class="kr">final</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">);</span>
   <span class="k">return</span> <span class="nx">dec</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>把用上面代码生成的带有用户信息的字符串写入到浏览器中，也就是在header中设置<span>set-cookie</span>或者在node中使用express框架可以直接使用<a href="http://expressjs.com/api.html#res.cookie" title="res.cookie">res.cookie</a></p>
<div class="highlight"><pre><code class="javascript language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">gen_session</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">auth_token</span> <span class="o">=</span> <span class="nx">encrypt</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">username</span> <span class="o">+</span> <span class="s1">&#39;\t&#39;</span> <span class="o">+</span> <span class="nx">user</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">session_secret</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">cookie</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">auth_cookie_name</span><span class="p">,</span> <span class="nx">auth_token</span><span class="p">,</span> <span class="p">{</span><span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="nx">maxAge</span><span class="o">:</span> <span class="mi">1000</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">7</span><span class="p">});</span> <span class="c1">//cookie 有效期1周            </span>
<span class="p">}</span>
</code></pre></div>
<p>浏览器端保存cookie之后就是需要再用户每次访问页面的时候做一个检测了：</p>
<div class="highlight"><pre><code class="javascript language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">cookie</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">cookies</span><span class="p">[</span><span class="nx">config</span><span class="p">.</span><span class="nx">auth_cookie_name</span><span class="p">];</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">cookie</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">();</span>

        <span class="kd">var</span> <span class="nx">auth_token</span> <span class="o">=</span> <span class="nx">decrypt</span><span class="p">(</span><span class="nx">cookie</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">session_secret</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">auth</span> <span class="o">=</span> <span class="nx">auth_token</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;\t&#39;</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">user_name</span> <span class="o">=</span> <span class="nx">auth</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</code></pre></div>
<p>ok，这样就可以实现一个可以有用户持久化登陆的网站或者应用了。</p>

  </div>
  <div class="post-meta">
    <span>Tags: </span>
    
      <span style="margin: 5px"><a href="/tags.html#nodejs">nodejs</a></span>
    
  </div>
  <div class="section-nav">
    <div class="left align-left">
      
      <a href="/2012/08/21/%E5%81%9A%E4%B8%80%E4%B8%AA%E6%B2%A1%E6%9C%89%E4%BB%BB%E4%BD%95%E9%80%BB%E8%BE%91%E9%99%B7%E9%98%B1%E7%9A%84%E7%A8%8B%E5%BA%8F%E5%91%98.html" class="prev-next">上一篇:<b> 做一个没有任何逻辑陷阱的程序员</b></a>
      
    </div>
    <div class="right align-right">
      
      <a href="/2012/10/21/Node.js%E5%AF%B9%E6%9C%AC%E5%9C%B0%E6%96%87%E4%BB%B6%E7%9A%84%E5%89%AA%E5%88%87%E4%B8%8E%E5%A4%8D%E5%88%B6.html" class="prev-next">下一篇:<b> Node.js对本地文件的剪切与复制</b></a>
      
    </div>
  </div>
</article>
<div class="box">
<!-- baidu shared -->
<div class="bdsharebuttonbox"><a href="#" class="bds_more" data-cmd="more"></a><a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a><a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博"></a><a href="#" class="bds_renren" data-cmd="renren" title="分享到人人网"></a><a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a></div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdPic":"","bdStyle":"0","bdSize":"16"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>
<!-- Comment BEGIN -->
<!-- Duoshuo Comment BEGIN -->
<div class="ds-thread"></div>
<script type="text/javascript">
var duoshuoQuery = {short_name:"yutingzhao"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = 'http://static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
  </script>
<!-- Duoshuo Comment END -->
<!-- Comment END -->
</div>


  </main>

  <footer>
    <a href='https://github.com/yutingzhao1991'>YuTingzhao</a> Copyright © 2014 i.yutingzhao.com
  </footer>
</body>
</html>
